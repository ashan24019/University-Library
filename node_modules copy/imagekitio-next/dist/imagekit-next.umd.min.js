!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react"),require("next/image")):"function"==typeof define&&define.amd?define(["exports","react","next/image"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).ImageKitNext={},e.React,e.NextImage)}(this,(function(e,t,r){"use strict";function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=n(t),i=n(r);function a(e){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a(e)}function s(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function u(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function c(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach((function(t){u(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function f(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function p(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return f(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?f(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw i}}}}var d={message:"Missing urlEndpoint during SDK initialization",help:""},m={message:"Invalid transformationPosition parameter",help:""},g={message:"Missing file parameter for upload",help:""},h={message:"Missing fileName parameter for upload",help:""},y={message:"Missing public key for upload",help:""},v={message:"Request to ImageKit upload endpoint failed due to network error",help:""},b={message:"Invalid uploadOptions parameter",help:""},w={message:"Missing signature for upload. The SDK expects token, signature and expire for authentication.",help:""},S={message:"Missing token for upload. The SDK expects token, signature and expire for authentication.",help:""},O={message:"Missing expire for upload. The SDK expects token, signature and expire for authentication.",help:""},P={message:"Invalid transformation parameter. Please include at least pre, post, or both.",help:""},x={message:"Invalid pre transformation parameter.",help:""},j={message:"Invalid post transformation parameter.",help:""};function E(e,t,r){"function"==typeof r&&(e?r(t,null):r(null,t))}function k(e){var t={},r=e.getAllResponseHeaders();return Object.keys(r).length&&r.trim().split(/[\r\n]+/).map((function(e){return e.split(/: /)})).forEach((function(e){t[e[0].trim()]=e[1].trim()})),t}var q=function(e,t){var r=c({},e),n={statusCode:t.status,headers:k(t)};return Object.defineProperty(r,"$ResponseMetadata",{value:n,enumerable:!1,writable:!1}),r},C=function(e,t){return new Promise((function(r,n){e.open("POST","https://upload.imagekit.io/api/v1/files/upload"),e.onerror=function(e){return n(v)},e.onload=function(){if(200===e.status)try{var t=JSON.parse(e.responseText),o=q(t,e);return r(o)}catch(e){return n(e)}else try{t=JSON.parse(e.responseText);var i=q(t,e);return n(i)}catch(e){return n(e)}},e.send(t)}))},I=function(e,t,r,n){if(t.file)if(t.fileName)if(r.publicKey)if(t.token)if(t.signature)if(t.expire){if(t.transformation){if(!Object.keys(t.transformation).includes("pre")&&!Object.keys(t.transformation).includes("post"))return void E(!0,P,n);if(Object.keys(t.transformation).includes("pre")&&!t.transformation.pre)return void E(!0,x,n);if(Object.keys(t.transformation).includes("post")){if(!Array.isArray(t.transformation.post))return void E(!0,j,n);var o,i=p(t.transformation.post);try{for(i.s();!(o=i.n()).done;){var s=o.value;if("abs"===s.type&&!s.protocol&&!s.value)return void E(!0,j,n);if("transformation"===s.type&&!s.value)return void E(!0,j,n)}}catch(e){i.e(e)}finally{i.f()}}}var u,l=new FormData;for(u in t)u&&("file"===u&&"string"!=typeof t.file?l.append("file",t.file,String(t.fileName)):"tags"===u&&Array.isArray(t.tags)?l.append("tags",t.tags.join(",")):"signature"===u?l.append("signature",t.signature):"expire"===u?l.append("expire",String(t.expire)):"token"===u?l.append("token",t.token):"responseFields"===u&&Array.isArray(t.responseFields)?l.append("responseFields",t.responseFields.join(",")):"extensions"===u&&Array.isArray(t.extensions)?l.append("extensions",JSON.stringify(t.extensions)):"customMetadata"!==u||"object"!==a(t.customMetadata)||Array.isArray(t.customMetadata)||null===t.customMetadata?"transformation"===u&&"object"===a(t.transformation)&&null!==t.transformation?l.append(u,JSON.stringify(t.transformation)):"checks"===u&&t.checks?l.append("checks",t.checks):void 0!==t[u]&&l.append(u,String(t[u])):l.append("customMetadata",JSON.stringify(t.customMetadata)));l.append("publicKey",r.publicKey),function(e,t,r){C(e,t).then((function(e){return E(!1,e,r)}),(function(e){return E(!0,e,r)}))}(e,l,n)}else E(!0,O,n);else E(!0,w,n);else E(!0,S,n);else E(!0,y,n);else E(!0,h,n);else E(!0,g,n)},M={width:"w",height:"h",aspectRatio:"ar",quality:"q",crop:"c",cropMode:"cm",focus:"fo",x:"x",y:"y",format:"f",radius:"r",background:"bg",border:"b",rotation:"rt",rotate:"rt",blur:"bl",named:"n",progressive:"pr",lossless:"lo",trim:"t",metadata:"md",colorProfile:"cp",defaultImage:"di",dpr:"dpr",effectSharpen:"e-sharpen",effectUSM:"e-usm",effectContrast:"e-contrast",effectGray:"e-grayscale",original:"orig",effectShadow:"e-shadow",effectGradient:"e-gradient",raw:"raw"},K="path",U="query",A=[K,U],F=function(){return K},T=function(e){return e.transformationPosition===U},N=function(e){return void 0!==e.transformationPosition&&-1!=A.indexOf(e.transformationPosition)},R=function(e){return e&&(M[e]||M[e.toLowerCase()])||""},L=function(){return":"},z=function(){return","},D=function(){return"-"};function J(e){return"string"==typeof e&&"/"==e[e.length-1]&&(e=e.substring(0,e.length-1)),e}function V(e){return"string"==typeof e&&"/"==e[0]&&(e=e.slice(1)),e}function $(e,t){var r=t||"/",n=new RegExp(r+"{1,}","g");return e.join(r).replace(n,r)}var H=function(e){if(!e.path&&!e.src)return"";var t,r,n;try{e.path?(n=new URL(e.urlEndpoint).pathname,t=new URL($([e.urlEndpoint.replace(n,""),e.path]))):(t=new URL(e.src),r=!0)}catch(e){return console.error(e),""}for(var o in e.queryParameters)t.searchParams.append(o,String(e.queryParameters[o]));var i=function(e){if(!Array.isArray(e))return"";for(var t=[],r=0,n=e.length;r<n;r++){var o=[];for(var i in e[r])if(void 0!==e[r][i]&&null!==e[r][i]){var a=R(i);if(a||(a=i),"-"===e[r][i])o.push(a);else if("raw"===i)o.push(e[r][i]);else{var s=e[r][i];"di"===a&&(s=(s=J(V(s||""))).replace(/\//g,"@@")),o.push([a,s].join(D()))}}t.push(o.join(z()))}return t.join(L())}(e.transformation);return i&&i.length&&(T(e)||r?t.searchParams.append("tr",i):t.pathname=$(["tr"+L()+i,t.pathname])),t.pathname=$(n?[n,t.pathname]:[t.pathname]),t.href};var G=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),u(this,"options",{sdkVersion:"javascript-".concat("3.0.2"),publicKey:"",urlEndpoint:"",transformationPosition:F()}),this.options=c(c({},this.options),t||{}),!this.options.urlEndpoint)throw d;if(!N(this.options))throw m}var t,r,n;return t=e,r=[{key:"url",value:function(e){return t=e,r=this.options,H(c(c({},r),t));var t,r}},{key:"upload",value:function(e,t,r){var n;if("function"==typeof t?n=t:r=t||{},!e||"object"!==a(e))return E(!0,b,n);var o=c(c({},this.options),r),i=(e||{}).xhr;delete e.xhr;var s,u,l=i||new XMLHttpRequest;return(s=this,u=I,function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];if(t.length!==u.length||void 0===t[t.length-1])return new Promise((function(e,r){t.pop(),t.push((function(t){if(t)return r(t);for(var n=arguments.length,o=new Array(n>1?n-1:0),i=1;i<n;i++)o[i-1]=arguments[i];e(o.length>1?o:o[0])})),u.call.apply(u,[s].concat(t))}));if("function"!=typeof t[t.length-1])throw new Error("Callback must be a function.");u.call.apply(u,[s].concat(t))})(l,e,o,n)}}],r&&s(t.prototype,r),n&&s(t,n),e}();function X(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r}function _(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{u(n.next(e))}catch(e){i(e)}}function s(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,s)}u((n=n.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const B=t.createContext({}),Q=e=>{const r=t.useContext(B);return{getIKClient:()=>{if(r&&r.ikClient)return r.ikClient;let{urlEndpoint:t}=e;if(t=t||r&&r.urlEndpoint,!t||""===t.trim())throw new Error("Missing urlEndpoint during initialization");return new G({urlEndpoint:t,sdkVersion:""})}}},W=({urlEndpoint:e,lqip:t,src:r,path:n,transformation:o,transformationPosition:i,queryParameters:a},s,u)=>{let l;if(r)l={urlEndpoint:e||u.urlEndpoint,src:r,transformation:o||void 0,transformationPosition:i||u.transformationPosition||void 0,queryParameters:a||{}};else{if(!n)return{originalSrc:""};l={urlEndpoint:e||u.urlEndpoint,path:n,transformation:o||void 0,transformationPosition:i||u.transformationPosition||void 0,queryParameters:a||{}}}const c={originalSrc:s.url(l)};if(t&&t.active){var f=Math.round(t.quality||t.threshold||20),p=Math.round(t.blur||6),d=l.transformation?[...l.transformation]:[];t.raw&&"string"==typeof t.raw&&""!==t.raw.trim()?d.push({raw:t.raw.trim()}):d.push({quality:String(f),blur:String(p)}),c.lqipSrc=s.url(Object.assign(Object.assign({},l),{transformation:d}))}return c};function Y(e,t){return e.some((e=>e.hasOwnProperty(t)))}const Z=({width:e,height:t,transformation:r,src:n,path:o,quality:i})=>{if((n||o)&&(e||i||t)){let n={};(null==r?void 0:r.length)&&(Y(r,"height")||Y(r,"width"))||(t&&(n.height=String(t)),e&&(n.width=String(e))),(null==r?void 0:r.length)&&Y(r,"quality")||!i||(n.quality=String(i)),Object.keys(n).length&&(r=(null==r?void 0:r.length)?[...r,n]:[n])}return r},ee=t.forwardRef(((e,r)=>{const[n,i]=t.useState({}),a=t.useContext(B),{getIKClient:s}=Q(Object.assign({},e));t.useEffect((()=>{const e=()=>{n.xhr&&n.xhr.abort()};if(r&&"object"==typeof r&&r.hasOwnProperty("current")){r.current.abort=e}}),[n.xhr,r]);const{publicKey:u,urlEndpoint:l,authenticator:c,fileName:f,useUniqueFileName:p,tags:d,folder:m,isPrivateFile:g,customCoordinates:h,responseFields:y,onError:v,onSuccess:b,onUploadStart:w,onUploadProgress:S,validateFile:O,webhookUrl:P,overwriteFile:x,overwriteAITags:j,overwriteTags:E,overwriteCustomMetadata:k,extensions:q,customMetadata:C,transformation:I,overrideParameters:M,checks:K}=e,U=X(e,["publicKey","urlEndpoint","authenticator","fileName","useUniqueFileName","tags","folder","isPrivateFile","customCoordinates","responseFields","onError","onSuccess","onUploadStart","onUploadProgress","validateFile","webhookUrl","overwriteFile","overwriteAITags","overwriteTags","overwriteCustomMetadata","extensions","customMetadata","transformation","overrideParameters","checks"]);return o.default.createElement("input",Object.assign({},U,{ref:r,type:"file",onChange:t=>{e.onChange&&"function"==typeof e.onChange&&e.onChange(t),(t=>{var r;const n=e.publicKey||a.publicKey,o=e.authenticator||a.authenticator,u=e.urlEndpoint||a.urlEndpoint;if(!n||""===n.trim())return void(v&&"function"==typeof v&&v({message:"Missing publicKey"}));if(!o)return void(v&&"function"==typeof v&&v({message:"The authenticator function is not provided."}));if("function"!=typeof o)return void(v&&"function"==typeof v&&v({message:"The provided authenticator is not a function."}));if(!u||""===u.trim())return void(v&&"function"==typeof v&&v({message:"Missing urlEndpoint"}));var l=s();const c=null===(r=t.target.files)||void 0===r?void 0:r[0];if(!c)return;if(e.validateFile&&!e.validateFile(c))return;e.onUploadStart&&"function"==typeof e.onUploadStart&&e.onUploadStart(t);let w={};e.overrideParameters&&"function"==typeof e.overrideParameters&&(w=e.overrideParameters(c)||{});const S=new XMLHttpRequest,O=t=>{e.onUploadProgress&&"function"==typeof e.onUploadProgress&&e.onUploadProgress(t)};S.upload.addEventListener("progress",O);var M={file:c,fileName:w.fileName||f||c.name,useUniqueFileName:w.useUniqueFileName||p,tags:w.tags||d,folder:w.folder||m,isPrivateFile:w.isPrivateFile||g,customCoordinates:w.customCoordinates||h,responseFields:y,extensions:w.extensions||q,webhookUrl:w.webhookUrl||P,overwriteFile:w.overwriteFile||x,overwriteAITags:w.overwriteAITags||j,overwriteTags:w.overwriteTags||E,overwriteCustomMetadata:w.overwriteCustomMetadata||k,customMetadata:w.customMetadata||C,signature:"",expire:0,token:"",xhr:S,transformation:w.transformation||I,checks:w.checks||K};const U=o();U instanceof Promise?U.then((({signature:e,token:t,expire:r})=>{M.signature=e,M.expire=r,M.token=t,l.upload(M,((e,t)=>{e?v&&"function"==typeof v&&v(e):b&&"function"==typeof b&&b(t),S.upload.removeEventListener("progress",O)}),{publicKey:n}),i({xhr:S})})).catch((e=>{var t;t=e instanceof Array?e[0]:e,v&&"function"==typeof v&&v({message:String(t)})})):v&&"function"==typeof v&&v({message:"The authenticator function is expected to return a Promise instance."})})(t)}}))}));e.IKImage=e=>{const[r,n]=t.useState(void 0),[a,s]=t.useState({}),[u,l]=t.useState(""),[c,f]=t.useState(""),[p,d]=t.useState(!1),[m,g]=t.useState(void 0),[h,y]=t.useState(!1),[v,b]=t.useState(!1),w=t.useRef(null),{getIKClient:S}=Q(Object.assign({},e)),O=t.useContext(B);t.useEffect((()=>{const{originalSrc:t,lqipSrc:r}=W(Object.assign(Object.assign({},e),{transformation:Z(e)}),S(),O);l(t),f(r||""),y(!0)}),[O,e]);const P=()=>_(void 0,void 0,void 0,(function*(){const t=yield(({lqip:e=null,loading:t},{intersected:r,originalSrcLoaded:n,originalSrc:o,lqipSrc:i})=>{const a=e=>e&&e.active;return"lazy"===t||a(e)?"lazy"!==t&&a(e)?n?o:i:"lazy"!==t||a(e)?r&&n?o:i:r?o:"":o})(e,{originalSrc:u,lqipSrc:c,intersected:v,contextOptions:O,initialzeState:h,originalSrcLoaded:p,observe:m});t&&n(t)})),x=()=>{var e=new Image;e.onload=()=>{d(!0)},e.src=u};t.useEffect((()=>{p&&P()}),[p]),t.useEffect((()=>{const t=w.current,{loading:r}=e;if(h)if(window&&"IntersectionObserver"in window&&"lazy"===r&&C){let e="1250px";"4g"!==(()=>{try{return navigator.connection.effectiveType}catch(e){return"4g"}})()&&(e="2500px");const r=new IntersectionObserver((e=>{const t=e[0];t&&t.isIntersecting&&!v&&(b(!0),g((e=>{e&&e.disconnect()})),x(),P())}),{rootMargin:`${e} 0px ${e} 0px`});t&&(r.observe(t),g(r))}else b(!0),x(),P();return()=>{m&&m.disconnect()}}),[e,u,c]);const{urlEndpoint:j,authenticator:E,publicKey:k,loading:q,lqip:C,path:I,src:M,transformation:K,transformationPosition:U,queryParameters:A,alt:F}=e,T=X(e,["urlEndpoint","authenticator","publicKey","loading","lqip","path","src","transformation","transformationPosition","queryParameters","alt"]),N=X(T,["fill","quality","priority","placeholder","blurDataURL","unoptimized","overrideSrc","onLoadingComplete","layout","objectFit","objectPosition","lazyBoundary","lazyRoot"]);return t.useEffect((()=>{const e=T;(null==K?void 0:K.length)&&K.some((e=>e.hasOwnProperty("height")||e.hasOwnProperty("width")))&&(e.height&&delete e.height,e.width&&delete e.width,e.fill=!0),s(e)}),[]),t.useEffect((()=>{(null==C?void 0:C.active)&&console.warn("In [imagekitio-next], loading is set to eager when LQIP is used.")}),[C]),null!=r&&Object.keys(a).length?o.default.createElement(i.default,Object.assign({loader:({src:e})=>e,alt:F,src:r||"",ref:w,unoptimized:!0,loading:(null==C?void 0:C.active)?"eager":q},a)):o.default.createElement("img",Object.assign({src:r||void 0,ref:w},N))},e.IKUpload=ee,e.IKVideo=e=>{const r=t.useRef(null),[n,i]=t.useState({currentUrl:"",contextOptions:{}}),{getIKClient:a}=Q(Object.assign({},e)),s=t.useContext(B);t.useEffect((()=>{const{originalSrc:t}=W(e,a(),s);i((e=>Object.assign(Object.assign({},e),{currentUrl:t,contextOptions:s})))}),[s,e]);const{currentUrl:u}=n,l=X(e,["urlEndpoint","publicKey","authenticator","path","src","transformation","transformationPosition","queryParameters"]);return o.default.createElement("video",Object.assign({},l,{ref:r,key:u}),o.default.createElement("source",{src:u||void 0,type:"video/mp4"}))},e.ImageKitClient=G,e.ImageKitContext=B,e.ImageKitProvider=e=>{const t=(e=>{const t=["publicKey","urlEndpoint","authenticator","transformationPosition","ikClient"];for(const r in e)t.includes(r)||delete e[r];return e})(Object.assign({},e));return t.urlEndpoint&&""!==t.urlEndpoint.trim()&&(t.ikClient=new G({urlEndpoint:t.urlEndpoint,sdkVersion:""})),o.default.createElement(B.Provider,{value:t},e.children)},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=imagekit-next.umd.min.js.map
